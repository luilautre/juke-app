<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JukeBox - Player</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  iframe {
    width: 100vw;
    height: 100vh;
    border: none;
  }
  #info {
    position: absolute;
    top: 10px;
    left: 10px;
    color: #fff;
    font-family: system-ui, sans-serif;
    background: rgba(0,0,0,0.5);
    padding: 0.5em 1em;
    border-radius: 5px;
  }
</style>
</head>
<body>
<div id="info">JukeBox Café - Player</div>

<iframe id="player" 
        allow="autoplay; encrypted-media; fullscreen" 
        allowfullscreen
        src="">
</iframe>

<script>
const params = new URLSearchParams(window.location.search);
const cafe = params.get('café') || 'default';
const key = params.get('key');
const player = document.getElementById('player');

if (!key) {
  document.body.innerHTML = '<p style="color:white;padding:1em;">Clé manquante !</p>';
  throw new Error('Missing key');
}

// Récupère le prochain morceau de la playlist
async function loadNext() {
  const peek = await fetch(`/peek?caf%C3%A9=${encodeURIComponent(cafe)}`);
  const data = await peek.json();

  if (!data.next) {
    // Playlist vide → vidéo d’attente
    player.src = 'https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1'; // remplacer par vidéo d’attente
    return;
  }

  const link = data.next.link;
  const videoIdMatch = link.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
  let embedUrl = link;

  if (videoIdMatch) embedUrl = `https://www.youtube.com/embed/${videoIdMatch[1]}?autoplay=1`;

  player.src = embedUrl;
}

// Pop le morceau actuel et charge le suivant (espace ou entrée)
document.addEventListener('keydown', async (e) => {
  if (e.key === ' ' || e.key === 'Enter') {
    await fetch(`/pop?caf%C3%A9=${encodeURIComponent(cafe)}&key=${encodeURIComponent(key)}`, { method: 'POST' });
    loadNext();
  }
});

// Chargement initial
loadNext();
</script>
</body>
</html>
