<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JukeBox - Player</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  #info {
    position: absolute;
    top: 10px;
    left: 10px;
    color: #fff;
    font-family: system-ui, sans-serif;
    background: rgba(0,0,0,0.5);
    padding: 0.5em 1em;
    border-radius: 5px;
  }
  #player {
    width: 100vw;
    height: 100vh;
  }
</style>
</head>
<body>
<div id="info">JukeBox Café - Player</div>
<div id="player"></div>

<!-- Script API YouTube -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
const params = new URLSearchParams(window.location.search);
const cafe = params.get('café') || 'default';
const key = params.get('key');

let player;

// Chargé automatiquement par l'API YouTube
function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    width: '100%',
    height: '100%',
    playerVars: { autoplay: 1, controls: 1 },
    events: {
      onReady: loadNext,
      onStateChange: onPlayerStateChange
    }
  });
}

// Quand la vidéo se termine
async function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    // On supprime le morceau joué
    await fetch(`/pop?caf%C3%A9=${encodeURIComponent(cafe)}&key=${encodeURIComponent(key)}`, { method: 'POST' });
    // Puis on charge le suivant
    loadNext();
  }
}

// Charge la prochaine vidéo
async function loadNext() {
  const peek = await fetch(`/peek?caf%C3%A9=${encodeURIComponent(cafe)}`);
  const data = await peek.json();

  let videoId = 'dQw4w9WgXcQ'; // par défaut (attente)
  if (data.next && data.next.link) {
    const match = data.next.link.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
    if (match) videoId = match[1];
  }

  player.loadVideoById(videoId);
}
</script>
</body>
</html>
